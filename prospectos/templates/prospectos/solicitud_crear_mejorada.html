{% extends "core/base.html" %}
{% load crispy_forms_tags %}
{% load static %} {# Asegúrate de cargar static si no lo está en tu base.html para iconos/imágenes #}

{% block page_title %}Crear Solicitud de Cliente{% endblock page_title %}

{% block content %}
<div class="container mt-5 mb-5"> {# Más margen superior e inferior para espacio #}
    
    <div class="row mb-5 align-items-center"> {# mb-5 para más espacio #}
        <div class="col-md-8"> {# Columna más ancha para el título #}
            <h1 class="display-5 fw-bold mb-0 text-primary"> {# Título más grande y en color primario #}
                <i class="fas fa-file-invoice me-3"></i>{{ titulo_pagina }}
            </h1>
            <p class="lead text-secondary mt-2 mb-0"> {# Texto descriptivo más destacado #}
                Diligencia los datos y adjunta la documentación requerida para el estudio de crédito.
            </p>
        </div>
        <div class="col-md-4 text-md-end"> {# Columna para el botón alineada a la derecha #}
            <a href="{% url 'core:index' %}" class="btn btn-outline-secondary btn-lg"> {# Botón más grande #}
                <i class="fas fa-arrow-left me-2"></i>Volver al Panel
            </a>
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" novalidate id="solicitud-form">
        {% csrf_token %}

        <div class="card shadow-lg mb-5 border-0 rounded-3"> {# Sombra más pronunciada, sin borde, redondeado #}
            <div class="card-header bg-primary-subtle py-4 rounded-top-3"> {# Fondo suave de color primario, más padding #}
                <h5 class="mb-0 text-primary"><i class="fas fa-user-tie me-3"></i>Información del Prospecto</h5> {# Icono más grande y espaciado #}
            </div>
            <div class="card-body p-5"> {# Más padding interno #}
                <div class="row g-4"> {# g-4 para más espacio entre campos #}
                    <div class="col-md-6">{{ form.nombre_completo|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.identificacion|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.email|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.telefono|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.ciudad|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.direccion|as_crispy_field }}</div>
                    <div class="col-12">{{ form.notas_vendedor|as_crispy_field }}</div>
                </div>
            </div>
        </div>

        <div class="card shadow-lg mb-5 border-0 rounded-3"> {# Sombra y redondeo consistentes #}
            <div class="card-header bg-primary-subtle py-4 rounded-top-3">
                <h5 class="mb-0 text-primary"><i class="fas fa-file-upload me-3"></i>Documentación para Estudio</h5>
            </div>
            <div class="card-body p-5">
                {{ documentos_formset.management_form }}

                <div id="documentos-ocultos-container" style="display: none;"></div>

                <div id="documento-activo-container" class="mb-4"> {# Agregado mb-4 para espaciado #}
                    {% for doc_form in documentos_formset %}
                        {% if not doc_form.instance.pk %}
                        <div class="document-form-row p-4 border rounded-3 bg-light mb-3"> {# Más padding, redondeado, sombra sutil #}
                            <div class="row g-3 align-items-center">
                                <div class="col-md-5">{{ doc_form.tipo_documento|as_crispy_field }}</div>
                                <div class="col-md-6 d-flex flex-column"> {# Usamos flex-column para alinear botón #}
                                    {{ doc_form.archivo|as_crispy_field }}
                                    <button type="button" class="btn btn-outline-secondary btn-sm mt-1 btn-camara align-self-start"> {# Alineado a la izquierda #}
                                        <i class="fas fa-camera me-1"></i> Tomar Foto
                                    </button>
                                </div>
                                <div class="col-md-1 text-end">
                                    <button type="button" class="btn btn-sm btn-danger remove-form-btn">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <div class="text-center my-4"> {# Más margen vertical #}
                    <button type="button" id="add-document-btn" class="btn btn-primary btn-lg rounded-pill"> {# Botón más grande y redondeado #}
                        <i class="fas fa-plus me-2"></i>Añadir Documento
                    </button>
                </div>
                
                <hr class="my-5 border-3 text-muted opacity-25"> {# Línea divisoria más gruesa y sutil #}

                <h6 class="text-secondary mb-3" id="lista-adjuntos-titulo" style="display: none;">Documentos Adjuntados:</h6> {# Color secundario #}
                <div id="documentos-adjuntados-lista" class="vstack gap-2"></div> {# gap-2 para más espacio entre items #}

                {# Plantilla oculta para nuevos formularios, se mantienen los estilos originales aquí para clonar #}
                <div id="empty-form" class="document-form-row p-4 border rounded-3 bg-light mb-3" style="display: none;">
                    <div class="row g-3 align-items-center">
                        <div class="col-md-5">{{ documentos_formset.empty_form.tipo_documento|as_crispy_field }}</div>
                        <div class="col-md-6 d-flex flex-column">
                            {{ documentos_formset.empty_form.archivo|as_crispy_field }}
                            <button type="button" class="btn btn-outline-secondary btn-sm mt-1 btn-camara align-self-start">
                                <i class="fas fa-camera me-1"></i> Tomar Foto
                            </button>
                        </div>
                        <div class="col-md-1 text-end">
                             <button type="button" class="btn btn-sm btn-danger remove-form-btn">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-5 d-flex justify-content-end gap-3"> {# Más margen superior, gap-3 #}
            <a href="{% url 'core:index' %}" class="btn btn-secondary btn-lg"> {# Botón más grande #}
                <i class="fas fa-times me-2"></i>Cancelar
            </a>
            <button type="submit" class="btn btn-success btn-lg"> {# Botón más grande #}
                <i class="fas fa-save me-2"></i>Enviar Solicitud
            </button>
        </div>
    </form>
</div>

<div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white"> {# Header del modal con color #}
        <h5 class="modal-title" id="cameraModalLabel">Tomar Foto del Documento</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button> {# Botón de cierre blanco #}
      </div>
      <div class="modal-body text-center p-4"> {# Más padding en el body del modal #}
        <video id="camera-stream" width="100%" height="auto" autoplay playsinline class="rounded shadow-sm"></video> {# Bordes redondeados, sombra #}
        <canvas id="camera-canvas" style="display:none;"></canvas>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-primary" id="capture-btn">Capturar Foto</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}


{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- CONTENEDORES PRINCIPALES ---
    const formContainer = document.querySelector('#solicitud-form');
    const addButton = document.querySelector('#add-document-btn');
    const totalFormsInput = document.querySelector('#id_documentos-TOTAL_FORMS');
    const activoContainer = document.querySelector('#documento-activo-container');
    const listaAdjuntosVisual = document.querySelector('#documentos-adjuntados-lista');
    const listaAdjuntosTitulo = document.querySelector('#lista-adjuntos-titulo');
    const emptyFormTemplate = document.querySelector('#empty-form');

    
    /**
     * Función principal que se ejecuta al hacer clic en "Añadir Documento".
     * Valida el form actual, lo oculta y añade uno nuevo.
     */
    function procesarYAnadirDocumento() {
        const formActivo = activoContainer.querySelector('.document-form-row');
        if (!formActivo) { return; }
        
        const tipoSelect = formActivo.querySelector('select[name$="tipo_documento"]');
        const fileInput = formActivo.querySelector('input[type="file"]');

        if (!tipoSelect.value || !fileInput || fileInput.files.length === 0) {
            alert('Por favor, seleccione un tipo de documento y adjunte el archivo.');
            return;
        }

        const tipoTexto = tipoSelect.options[tipoSelect.selectedIndex].text;
        const nombreArchivo = fileInput.files[0].name;
        const formIndexMatch = formActivo.querySelector('select[name$="tipo_documento"]').name.match(/(\d+)/);
        const formIndex = formIndexMatch ? formIndexMatch[0] : (totalFormsInput.value - 1);

        const itemVisual = document.createElement('div');
        itemVisual.className = 'list-group-item d-flex justify-content-between align-items-center';
        itemVisual.setAttribute('data-form-ref-id', `documentos-${formIndex}-row`);
        
        itemVisual.innerHTML = `
            <span>
                <i class="fas fa-check-circle text-success me-2"></i>
                <strong>${tipoTexto}:</strong>
                <em class="text-muted ms-2">${nombreArchivo}</em>
            </span>
            <button type="button" class="btn btn-sm btn-outline-danger remove-visual-btn">
                <i class="fas fa-trash-alt"></i>
            </button>
        `;
        listaAdjuntosVisual.appendChild(itemVisual);
        listaAdjuntosTitulo.style.display = 'block';

        document.getElementById('documentos-ocultos-container').appendChild(formActivo);
        formActivo.style.display = 'none';
        formActivo.id = `documentos-${formIndex}-row`;

        const nuevoForm = emptyFormTemplate.cloneNode(true);
        nuevoForm.removeAttribute('id');
        nuevoForm.style.display = 'block';
        
        let formNum = parseInt(totalFormsInput.value);
        nuevoForm.innerHTML = nuevoForm.innerHTML.replace(/__prefix__/g, formNum);
        
        activoContainer.appendChild(nuevoForm);
        totalFormsInput.value = formNum + 1;

        updateDocumentOptions();
    }


    /**
     * Función para eliminar un documento añadido.
     */
    function eliminarDocumento(removeButton) {
        const itemVisual = removeButton.closest('.list-group-item');
        const formId = itemVisual.getAttribute('data-form-ref-id');
        const formOculto = document.getElementById(formId);

        if (formOculto) {
            const deleteInput = formOculto.querySelector('input[name$="-DELETE"]');
            if (deleteInput) { deleteInput.checked = true; }
        }
        itemVisual.style.display = 'none';
        
        if (listaAdjuntosVisual.querySelectorAll('.list-group-item[style*="display: none;"]').length === listaAdjuntosVisual.children.length) {
            listaAdjuntosTitulo.style.display = 'none';
        }
        updateDocumentOptions();
    }


    /**
     * Actualiza los <select> para no permitir duplicados.
     */
    function updateDocumentOptions() {
        const selects = formContainer.querySelectorAll('select[name$="tipo_documento"]');
        let selectedValues = [];
        
        document.querySelectorAll('.document-form-row').forEach(formRow => {
            const isMarkedForDelete = formRow.querySelector('input[name$="-DELETE"]:checked');
            if (!isMarkedForDelete) {
                const select = formRow.querySelector('select[name$="tipo_documento"]');
                if (select && select.value) { selectedValues.push(select.value); }
            }
        });

        const activeSelect = activoContainer.querySelector('select[name$="tipo_documento"]');
        if (activeSelect) {
            for (const option of activeSelect.options) {
                if (option.value && selectedValues.includes(option.value)) {
                    option.style.display = 'none';
                } else {
                    option.style.display = '';
                }
            }
        }
    }

    // --- LÓGICA DE LA CÁMARA (CÓDIGO ORIGINAL) ---
    const cameraModal = new bootstrap.Modal(document.getElementById('cameraModal'));
    const video = document.getElementById('camera-stream');
    const canvas = document.getElementById('camera-canvas');
    const captureBtn = document.getElementById('capture-btn');
    let currentStream = null;
    let targetFileInput = null;

    async function startCamera(button) {
        targetFileInput = button.closest('.document-form-row').querySelector('input[type="file"]');
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = currentStream;
                cameraModal.show();
            } catch (err) {
                console.error("Error al acceder a la cámara: ", err);
                alert("No se pudo acceder a la cámara. Asegúrate de dar permisos.");
            }
        } else {
            alert("Tu navegador no soporta el acceso a la cámara.");
        }
    }
    
    function stopCamera() {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
            video.srcObject = null;
            currentStream = null;
        }
    }

    captureBtn.addEventListener('click', () => {
        if (currentStream && targetFileInput) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            canvas.toBlob(function(blob) {
                const fileName = `captura-${new Date().toISOString()}.jpg`;
                const capturedFile = new File([blob], fileName, { type: 'image/jpeg' });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(capturedFile);
                targetFileInput.files = dataTransfer.files;
                cameraModal.hide();
            }, 'image/jpeg');
        }
    });

    // --- ASIGNACIÓN DE EVENTOS ---
    addButton.addEventListener('click', procesarYAnadirDocumento);

    // Delegación de eventos para los botones de eliminar y cámara
    formContainer.addEventListener('click', function(e) {
        const removeBtn = e.target.closest('.remove-visual-btn');
        const cameraBtn = e.target.closest('.btn-camara');

        if (removeBtn) {
            eliminarDocumento(removeBtn);
        }
        if (cameraBtn) {
            startCamera(cameraBtn);
        }
    });
    
    document.getElementById('cameraModal').addEventListener('hidden.bs.modal', stopCamera);



        // --- INICIO DEL CÓDIGO AÑADIDO PARA LA SOLUCIÓN ---
    // Se ejecuta justo antes de que el formulario se envíe al servidor.
    formContainer.addEventListener('submit', function(e) {
        const formActivo = activoContainer.querySelector('.document-form-row');
        
        // Revisa si existe una última fila activa de formulario
        if (formActivo) {
            const tipoSelect = formActivo.querySelector('select[name$="tipo_documento"]');
            const fileInput = formActivo.querySelector('input[type="file"]');

            // Si ambos campos de la última fila están vacíos...
            if (!tipoSelect.value && (!fileInput || fileInput.files.length === 0)) {
                // ...la eliminamos del DOM...
                formActivo.remove();
                // ...y actualizamos el contador TOTAL_FORMS para que Django no la espere.
                totalFormsInput.value = parseInt(totalFormsInput.value) - 1;
            }
        }
    });

    // --- INICIALIZACIÓN ---
    updateDocumentOptions();
});
</script>
{% endblock extra_scripts %}