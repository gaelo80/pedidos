{% extends 'core/base.html' %}
{% load static %}

{% block page_title %}{{ titulo|default:"Registrar Ingreso Bodega" }}{% endblock page_title %}

{% block content %}
{#<h1>{{ titulo }}</h1>#}
    <div class="row">
        <div class="col-md-8">
            <h1 class="mb-3">{{ titulo }}</h1>
        </div>
        <div class="col-md-4 text-md-end mb-3">
            <a href="{% url 'core:index' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Volver al Panel Principal
            </a>
        </div>
    </div>

<form method="post" novalidate>
    {% csrf_token %}

    {# --- Sección Cabecera Ingreso --- #}
    <div class="card mb-4">
        <div class="card-header fw-bold">
            Información del Ingreso
        </div>
        <div class="card-body">
            {# Renderizar campos del form principal (IngresoBodegaForm) #}
            <div class="row g-3">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.proveedor_info.id_for_label }}" class="form-label">{{ form.proveedor_info.label }}</label>
                    {{ form.proveedor_info }}
                    {% if form.proveedor_info.errors %}<div class="text-danger small">{{ form.proveedor_info.errors }}</div>{% endif %}
                    <div class="form-text">{{ form.proveedor_info.help_text }}</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.documento_referencia.id_for_label }}" class="form-label">{{ form.documento_referencia.label }}</label>
                    {{ form.documento_referencia }}
                    {% if form.documento_referencia.errors %}<div class="text-danger small">{{ form.documento_referencia.errors }}</div>{% endif %}
                    <div class="form-text">{{ form.documento_referencia.help_text }}</div>
                </div>
                <div class="col-12 mb-3">
                    <label for="{{ form.notas.id_for_label }}" class="form-label">{{ form.notas.label }}</label>
                    {{ form.notas }}
                    {% if form.notas.errors %}<div class="text-danger small">{{ form.notas.errors }}</div>{% endif %}
                    <div class="form-text">{{ form.notas.help_text }}</div>
                </div>
            </div>
             {% if form.non_field_errors %}
                 <div class="alert alert-danger p-2 mt-2">{{ form.non_field_errors }}</div>
             {% endif %}
        </div>
    </div>

    {# --- Sección Detalles Ingreso (FormSet) --- #}
    <div class="card">
        <div class="card-header fw-bold">
            Productos Ingresados
        </div>
        <div class="card-body">
            {# Campo oculto necesario para manejar el FormSet #}
            {{ formset.management_form }}

            {% if formset.non_form_errors %}
                 <div class="alert alert-danger p-2">{{ formset.non_form_errors }}</div>
            {% endif %}

            {# Contenedor para las filas del formset #}
            <div id="detalle-ingreso-list">
                {# Iterar sobre cada formulario individual dentro del FormSet #}
                {% for detalle_form in formset %}
                    <div class="detalle-ingreso-item border-bottom pb-3 mb-3">
                        {{ detalle_form.id }} {# Campo oculto #}
                        <div class="row g-3 align-items-end">
                            <div class="col-md-5">
                                <label for="{{ detalle_form.producto.id_for_label }}" class="form-label">{{ detalle_form.producto.label }}</label>
                                {{ detalle_form.producto }}
                                {% if detalle_form.producto.errors %}<div class="text-danger small">{{ detalle_form.producto.errors }}</div>{% endif %}
                            </div>
                            <div class="col-md-3">
                                <label for="{{ detalle_form.cantidad.id_for_label }}" class="form-label">{{ detalle_form.cantidad.label }}</label>
                                {{ detalle_form.cantidad }}
                                {% if detalle_form.cantidad.errors %}<div class="text-danger small">{{ detalle_form.cantidad.errors }}</div>{% endif %}
                            </div>
                            <div class="col-md-3">
                                <label for="{{ detalle_form.costo_unitario.id_for_label }}" class="form-label">{{ detalle_form.costo_unitario.label }}</label>
                                {{ detalle_form.costo_unitario }}
                                {% if detalle_form.costo_unitario.errors %}<div class="text-danger small">{{ detalle_form.costo_unitario.errors }}</div>{% endif %}
                            </div>
                        </div>
                         {% if detalle_form.non_field_errors %}
                             <div class="alert alert-warning p-1 mt-2 small">{{ detalle_form.non_field_errors }}</div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>

            {# --- BOTÓN PARA AGREGAR FILAS --- #}
            <div class="text-end mt-3">
                <button type="button" id="add-detalle-ingreso" class="btn btn-primary btn-sm">
                    <i class="fas fa-plus me-1"></i> Agregar Producto
                </button>
            </div>

        </div> {# Fin card-body #}

        <div class="card-footer text-center">
            <button type="submit" class="btn btn-success btn-lg">Registrar Ingreso</button>
        </div>
    </div> {# Fin card #}

</form>

{# --- PLANTILLA OCULTA PARA LA NUEVA FILA --- #}
<template id="detalle-ingreso-template">
    <div class="detalle-ingreso-item border-bottom pb-3 mb-3">
        {# El formset.empty_form usa '__prefix__' como placeholder para el índice de la nueva fila #}
        {{ formset.empty_form.id }}
        <div class="row g-3 align-items-end">
            <div class="col-md-5">
                <label for="{{ formset.empty_form.producto.id_for_label }}" class="form-label">{{ formset.empty_form.producto.label }}</label>
                {{ formset.empty_form.producto }}
            </div>
            <div class="col-md-3">
                <label for="{{ formset.empty_form.cantidad.id_for_label }}" class="form-label">{{ formset.empty_form.cantidad.label }}</label>
                {{ formset.empty_form.cantidad }}
            </div>
            <div class="col-md-3">
                <label for="{{ formset.empty_form.costo_unitario.id_for_label }}" class="form-label">{{ formset.empty_form.costo_unitario.label }}</label>
                {{ formset.empty_form.costo_unitario }}
            </div>
        </div>
    </div>
</template>

{% endblock content %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const addRowBtn = document.getElementById('add-detalle-ingreso');
    const formsetContainer = document.getElementById('detalle-ingreso-list');
    const formTemplate = document.getElementById('detalle-ingreso-template');
    const totalFormsInput = document.querySelector('[name="{{ formset.prefix }}-TOTAL_FORMS"]');
    
    // Verificación para evitar errores si los elementos no existen
    if (!addRowBtn || !formsetContainer || !formTemplate || !totalFormsInput) {
        console.error("No se encontraron los elementos necesarios para el formset dinámico.");
        return;
    }

    addRowBtn.addEventListener('click', function() {
        // Obtener el número actual de formularios
        let formCount = parseInt(totalFormsInput.value);

        // Clonar el contenido de la plantilla
        const newForm = formTemplate.content.cloneNode(true);
        
        // Actualizar los atributos 'id', 'name', y 'for' en el clon
        // reemplazando '__prefix__' con el nuevo índice
        newForm.querySelectorAll('*').forEach(node => {
            ['id', 'name', 'for'].forEach(attr => {
                let value = node.getAttribute(attr);
                if (value) {
                    node.setAttribute(attr, value.replace(/__prefix__/g, formCount));
                }
            });
        });

        // Añadir la nueva fila al contenedor
        formsetContainer.append(newForm);
        
        // Incrementar el contador de formularios en el management_form
        totalFormsInput.value = formCount + 1;
    });
});
</script>
{% endblock extra_scripts %}