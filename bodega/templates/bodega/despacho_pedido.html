{% extends 'core/base.html' %}
{% load static %}
{% load humanize %} {# Asumo que lo necesitas si lo tienes en tu base #}
{# {% load core_extras %} #} {# Comentado si no estás seguro si despacho_pedido.html lo usa directamente #}

{% block page_title %}{{ titulo }}{% endblock page_title %}

{% block extra_head %}
    {{ block.super }}
<style>
    /* Estilos generales para el layout de pantalla completa */
    body, html {
        height: 100%;
    }
    .container.mt-4 {
        max-width: 100%; /* Usar todo el ancho disponible */
        padding: 0 15px; /* Pequeño padding lateral */
    }
    .card.shadow-lg {
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
    }

    /* Estilos para la tarjeta de producto activo */
    #producto-activo-card {
        min-height: 400px; /* Altura mínima para que siempre se vea bien */
        display: flex; /* Usar flexbox para centrar contenido */
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
    }
    #producto-activo-card .card-body {
        flex-grow: 1; /* Permite que el cuerpo ocupe el espacio restante */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    #producto-referencia-nombre {
        font-size: 2.5rem; /* Más grande */
        margin-bottom: 0.5rem;
    }
    #producto-color-talla {
        font-size: 1.8rem;
        margin-bottom: 1rem;
    }
    #producto-codigo-barras {
        font-family: 'monospace'; /* Para que el código de barras se vea bien */
        font-size: 1.2rem;
        letter-spacing: 1px;
    }
    #cantidad-despachada-display {
        font-size: 4rem; /* Muy grande */
    }
    .d-flex.align-items-baseline span {
        font-size: 1.5rem;
    }
    .d-flex.align-items-baseline strong {
        font-size: 2.5rem;
        display: block; /* Para que el número vaya debajo del texto */
    }
    #cantidad-pedida-display, #cantidad-pendiente-display {
        font-size: 2rem;
    }

    /* Estilos para la lista de pendientes */
    #lista-pendientes {
        max-height: calc(100vh - 450px); /* Ajusta este valor según la altura de tu header y footer, 450px es un estimado */
        overflow-y: auto; /* Scroll si hay muchos ítems */
    }
    .list-group-item-success {
        background-color: #d1e7dd; /* success-subtle */
    }
    .list-group-item-warning {
        background-color: #fff3cd; /* warning-subtle */
    }
    .list-group-item-light {
        background-color: #f8f9fa; /* light */
    }

    /* Estilo para el input de escaneo */
    #barcode-input {
        height: 60px; /* Más alto */
        font-size: 1.5rem; /* Texto más grande */
    }

    /* Mensajes de estado del escáner */
    #scan_status {
        min-height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: .5rem;
        padding: .5rem 1rem;
        font-weight: bold;
    }

    /* Animación de resaltado (opcional) */
    .highlight-success {
        animation: highlightFade 1.5s ease-out forwards;
    }

    @keyframes highlightFade {
        0% { background-color: rgba(186, 230, 203, 0.7); } /* Verde claro */
        100% { background-color: transparent; }
    }
</style>
{% endblock extra_head %}

{% block content %}
    <div class="row">
        <div class="col-md-8">
            <h1 class="mb-3">{{ titulo }}</h1>
        </div>
        <div class="col-md-4 text-md-end mb-3">
            <a href="{% url 'core:index' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Volver al Panel Principal
            </a>
        </div>
    </div>
    <div class="container mt-4">

        {#<h2 class="mb-4">{{ titulo }}</h2>#}

        <div class="card mb-3">
            <div class="card-body row">
                <div class="col-md-6">
                    <strong>Cliente:</strong> {{ pedido.cliente.nombre_completo|default:"N/A" }}<br>
                    <strong>NIT/ID:</strong> {{ pedido.cliente.identificacion|default:"N/A" }}<br>
                    <strong>Fecha Pedido:</strong> {{ pedido.fecha_hora|date:"Y-m-d H:i" }}
                </div>
                <div class="col-md-6">
                    <strong>Estado Actual:</strong> <span class="badge bg-info">{{ pedido.get_estado_display }}</span><br>
                    <strong>Vendedor:</strong> {{ pedido.vendedor.user.get_full_name|default:pedido.vendedor.user.username|default:"N/A" }}
                </div>
                {% if pedido.notas %}
                <div class="col-12 mt-3">
                    <strong>Observaciones del Vendedor:</strong><br>
                    <div class="border rounded p-2 bg-light">
                        {{ pedido.notas|linebreaksbr }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>


        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}

        <form method="post" id="despacho-form">
            {% csrf_token %}

            {{ detalles_json|json_script:"productos-data" }}

            <div class="row mb-4 align-items-center">

                <div class="col-md-3">
                    <label for="scanner_input" class="form-label fw-bold h4 text-white">Escanear Producto:</label>

                </div>

                <div class="col-md-6">
                    <input type="text" id="barcode-input" class="form-control form-control-lg" placeholder="Esperando código de barras..." autofocus autocomplete="off">
                </div>

                <div class="col-md-3" id="scan_status">
                    </div>

            </div>
            <audio id="audio_success" src="{% static 'sounds/success.mp3' %}" preload="auto"></audio>
            <audio id="audio_error" src="{% static 'sounds/error.mp3' %}" preload="auto"></audio>

            <div class="row mt-4">
                <div class="col-md-8">
                    <div id="producto-activo-card" class="card shadow-lg border-primary mb-3">
                        <div class="card-header bg-primary text-white h4">
                            Producto Actual / Siguiente para Despachar
                        </div>
                        <div class="card-body text-center d-flex flex-column justify-content-center align-items-center">
                            <p class="text-muted" id="instruccion-inicial">Escanee un producto o seleccione uno de la lista de pendientes.</p>
                            <h3 id="producto-referencia-nombre" class="display-5 fw-bold text-primary">---</h3>
                            <h4 id="producto-color-talla" class="text-secondary">---</h4>
                            <p class="lead text-muted">Código de Barras: <strong id="producto-codigo-barras">---</strong></p>

                            <div class="d-flex align-items-baseline my-3">
                                <span class="fs-4 me-3">Pedido: <strong id="cantidad-pedida-display" class="text-info">0</strong></span>
                                <span class="fs-1 mx-4">Despachado: <strong id="cantidad-despachada-display" class="text-success">0</strong></span>
                                <span class="fs-4 ms-3">Pendiente: <strong id="cantidad-pendiente-display" class="text-danger">0</strong></span>
                            </div>


                            <div class="mt-4">
                                {# <button type="button" class="btn btn-outline-secondary me-2" id="btn-prev-product"><i class="fas fa-chevron-left"></i> Anterior</button> #}
                                {# <button type="button" class="btn btn-outline-secondary" id="btn-next-product">Siguiente <i class="fas fa-chevron-right"></i></button> #}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card shadow-sm mb-3">
                        <div class="card-header bg-light text-dark h5">
                            Resumen del Pedido
                        </div>
                        <div class="card-body p-0">
                            <ul class="list-group list-group-flush" id="lista-pendientes">
                                <li class="list-group-item text-muted text-center py-4" id="cargando-pendientes">Cargando ítems...</li>
                            </ul>
                        </div>
                    </div>

                    <div class="card shadow-sm mt-3">
                        <div class="card-header bg-light text-dark h5">
                            Totales del Despacho
                        </div>
                        <div class="card-body">
                            <p class="mb-1">Cantidad Pedida Total: <strong id="total-pedido-display" class="float-end">0</strong></p>
                            <p class="mb-0">Cantidad Despachada Total: <strong id="total-despachado-display" class="float-end text-success">0</strong></p>
                            <hr>
                            <p class="mb-0 fs-5">Pendiente por Despachar: <strong id="total-pendiente-display" class="float-end text-danger">0</strong></p>
                        </div>
                    </div>
                </div>
            </div>


             <div class="mt-4 d-flex justify-content-between">

                    <a href="{% url 'bodega:lista_pedidos_bodega' %}" class="btn btn-info">
                        <i class="fas fa-list"></i> Volver a la Lista de Pedidos
                    </a>

                 <button type="button" class="btn btn-info btn-lg" id="btn-enviar-parcial">
                     <i class="fas fa-paper-plane me-2"></i> Enviar Parcial
                 </button>

                <button type="button" class="btn btn-secondary" id="btn-guardar-parcial-ajax">
                    <i class="fas fa-save"></i> Guardar Despacho Parcial
                </button>
                 {% if puede_finalizar %}
                 <button type="submit" name="action" value="finalizar_despacho" class="btn btn-success" id="btn-finalizar">
                     <i class="fas fa-check-circle"></i> Finalizar y Marcar como Enviado
                 </button>
                 {% endif %}

                 <form method="post" action="{% url 'bodega:finalizar_pedido_incompleto' pk=pedido.pk %}" style="display:inline;" onsubmit="return confirm('¿Está seguro de finalizar este pedido como incompleto y devolver el stock pendiente?');">
                     {% csrf_token %}
                     <button type="submit" class="btn btn-warning"><i class="fas fa-exclamation-triangle"></i> Finalizar Incompleto</button>
                 </form>
                 <form method="post" action="{% url 'bodega:cancelar_pedido_bodega' pk=pedido.pk %}" style="display:inline;" onsubmit="return confirm('¿Está seguro de CANCELAR completamente este pedido y reintegrar todo el stock? Esta acción no se puede deshacer.');">
                     {% csrf_token %}
                     <button type="submit" class="btn btn-danger"><i class="fas fa-times-circle"></i> Cancelar Pedido</button>
                 </form>
             </div>
        </form>
    </div>

    <div class="modal fade" id="mensajeModal" tabindex="-1" aria-labelledby="mensajeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mensajeModalLabel"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="mensajeModalBody">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
{% endblock content %} 

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- URLs y Token CSRF (se mantiene igual) ---
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const guardarParcialUrl = "{% url 'bodega:guardar_parcial_ajax' pk=pedido.pk %}";
    const enviarParcialUrl = "{% url 'bodega:enviar_parcial_ajax' pk=pedido.pk %}";

    // --- LÓGICA DE CARGA DE DATOS (MÉTODO INICIAL CORREGIDO) ---
    // Se añade el filtro |safe para evitar la doble codificación y se eliminan las limpiezas manuales
    const jsonDataString = '{{ detalles_json|escapejs|safe|default:"[]" }}';
    let gruposData = {};
    let detallesIndividualesPorCodigoBarras = {};

    try {
        // Ahora el parseo debería funcionar directamente
        const jsonData = JSON.parse(jsonDataString);
        
        if (Array.isArray(jsonData)) {
            jsonData.forEach(grupo => {
                const grupoKey = `${grupo.referencia}-${grupo.color}`;
                gruposData[grupoKey] = grupo;
                if (grupo.tallas) {
                    grupo.tallas.forEach(tallaInfo => {
                        const detalleIndividual = tallaInfo.detalle;
                        detalleIndividual.grupoKey = grupoKey;
                        detalleIndividual.talla_nombre = tallaInfo.nombre;
                        detalleIndividual.referencia = grupo.referencia;
                        detalleIndividual.nombre = grupo.nombre;
                        detalleIndividual.color = grupo.color;
                        if (detalleIndividual.codigo_barras) {
                            detallesIndividualesPorCodigoBarras[detalleIndividual.codigo_barras.trim()] = detalleIndividual;
                        }
                    });
                }
            });
        }
    } catch (e) {
        console.error("ERROR CRÍTICO: Fallo al parsear JSON:", e);
        // Puedes mostrar un mensaje de error más visible al usuario aquí
    }

    // --- El resto de tu código JavaScript se mantiene exactamente igual ---
    const barcodeInput = document.getElementById('barcode-input');
    // ... (todas las demás variables y funciones como mostrarStatus, playSound, procesarScan, etc.)

    // (Pega aquí el resto de tu bloque de script original, desde la declaración
    // de 'barcodeInput' hasta el final, ya que esa parte no necesita cambios)

    // Para evitar dudas, aquí tienes el script completo de nuevo, usando el método inicial corregido.
    const scanStatusDiv = document.getElementById('scan_status');
    const btnEnviarParcial = document.getElementById('btn-enviar-parcial');
    const btnGuardarParcialAjax = document.getElementById('btn-guardar-parcial-ajax');
    
    if (btnGuardarParcialAjax) {
        btnGuardarParcialAjax.addEventListener('click', guardarTodosDetallesParcialmente);
    }
    
    const productoActivoCard = document.getElementById('producto-activo-card');
    const instruccionInicial = document.getElementById('instruccion-inicial');
    const productoReferenciaNombre = document.getElementById('producto-referencia-nombre');
    const productoColorTalla = document.getElementById('producto-color-talla');
    const productoCodigoBarras = document.getElementById('producto-codigo-barras');
    const cantidadPedidaDisplay = document.getElementById('cantidad-pedida-display');
    const cantidadDespachadaDisplay = document.getElementById('cantidad-despachada-display');
    const cantidadPendienteDisplay = document.getElementById('cantidad-pendiente-display');
    const successAudio = document.getElementById('audio_success');
    const errorAudio = document.getElementById('audio_error');
    const listaPendientes = document.getElementById('lista-pendientes');
    const totalPedidoDisplay = document.getElementById('total-pedido-display');
    const totalDespachadoDisplay = document.getElementById('total-despachado-display');
    const totalPendienteDisplay = document.getElementById('total-pendiente-display');
    const mensajeModal = new bootstrap.Modal(document.getElementById('mensajeModal'));
    const mensajeModalLabel = document.getElementById('mensajeModalLabel');
    const mensajeModalBody = document.getElementById('mensajeModalBody');

    function mostrarStatus(mensaje, tipo = 'info', duracion = 2500, usarModal = false) {
        if (scanStatusDiv) {
            scanStatusDiv.textContent = mensaje;
            scanStatusDiv.className = `col-md-3 ms-2 badge fs-5 bg-${tipo}`;
            setTimeout(() => {
                scanStatusDiv.textContent = '';
                scanStatusDiv.className = 'col-md-3 ms-2';
            }, duracion);
        }
        if (usarModal) {
            mensajeModalLabel.textContent = tipo === 'success' ? 'Éxito' : (tipo === 'danger' ? 'Error' : 'Advertencia');
            mensajeModalBody.innerHTML = mensaje;
            const modalHeader = document.querySelector('#mensajeModal .modal-header');
            modalHeader.className = 'modal-header'; // Limpiar clases
            modalHeader.classList.add(tipo === 'success' ? 'bg-success' : (tipo === 'danger' ? 'bg-danger' : 'bg-warning'), 'text-white');
             if(tipo === 'warning') modalHeader.classList.replace('text-white', 'text-dark');
            mensajeModal.show();
        }
    }
    function playSound(type) { if (type === 'success' && successAudio) successAudio.play(); else if (type === 'error' && errorAudio) errorAudio.play(); }
    
    function actualizarProductoActivoCard(detalleIndividual) {
        if (!detalleIndividual) {
            instruccionInicial.style.display = 'block';
            productoReferenciaNombre.textContent = '---';
            productoColorTalla.textContent = '---';
            productoCodigoBarras.textContent = '---';
            cantidadPedidaDisplay.textContent = '0';
            cantidadDespachadaDisplay.textContent = '0';
            cantidadPendienteDisplay.textContent = '0';
            return;
        }
        instruccionInicial.style.display = 'none';
        productoReferenciaNombre.textContent = `${detalleIndividual.referencia || '-'} - ${detalleIndividual.nombre || '-'}`;
        productoColorTalla.textContent = `${detalleIndividual.color || '-'} - Talla ${detalleIndividual.talla_nombre || '-'}`;
        productoCodigoBarras.textContent = detalleIndividual.codigo_barras || '-';
        cantidadPedidaDisplay.textContent = detalleIndividual.cantidad_pedida;
        cantidadDespachadaDisplay.textContent = detalleIndividual.cantidad_verificada;
        cantidadPendienteDisplay.textContent = detalleIndividual.cantidad_pedida - detalleIndividual.cantidad_verificada;
        productoActivoCard.className = 'card shadow-lg mb-3';
        if (detalleIndividual.cantidad_verificada >= detalleIndividual.cantidad_pedida) productoActivoCard.classList.add('border-success');
        else if (detalleIndividual.cantidad_verificada > 0) productoActivoCard.classList.add('border-warning');
        else productoActivoCard.classList.add('border-primary');
    }

    function renderListaPendientes() {
        listaPendientes.innerHTML = '';
        if (Object.keys(gruposData).length === 0) {
            listaPendientes.innerHTML = '<li class="list-group-item text-muted text-center py-4">No hay productos en este pedido.</li>';
            return;
        }
        Object.values(gruposData).sort((a,b) => a.referencia.localeCompare(b.referencia)).forEach(grupo => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            let estadoClase = 'list-group-item-light';
            if (grupo.total_verificada >= grupo.total_pedida && grupo.total_pedida > 0) estadoClase = 'list-group-item-success';
            else if (grupo.total_verificada > 0) estadoClase = 'list-group-item-warning';
            li.classList.add(estadoClase);

            const grupoId = `grupo-${grupo.referencia}-${grupo.color}`;
            let headerHTML = `<div class="d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#${grupoId}" style="cursor: pointer;">
                                <div><strong>${grupo.referencia}</strong> - ${grupo.nombre} (${grupo.color})</div>
                                <span class="badge bg-primary rounded-pill">${grupo.total_verificada} / ${grupo.total_pedida}</span>
                              </div>`;
            let tallasHTML = `<div class="collapse" id="${grupoId}"><ul class="list-group list-group-flush mt-2">`;
            grupo.tallas.forEach(tallaInfo => {
                const detalle = tallaInfo.detalle;
                let itemClass = '';
                if(detalle.cantidad_verificada >= detalle.cantidad_pedida) itemClass = 'list-group-item-success';
                else if (detalle.cantidad_verificada > 0) itemClass = 'list-group-item-warning';
                tallasHTML += `<li class="list-group-item ${itemClass} d-flex justify-content-between align-items-center" data-detalle-id="${detalle.id}" style="cursor: pointer;">
                                Talla: <strong>${tallaInfo.nombre}</strong>
                                <span class="badge bg-secondary rounded-pill">${detalle.cantidad_verificada} / ${detalle.cantidad_pedida}</span>
                               </li>`;
            });
            tallasHTML += `</ul></div>`;
            li.innerHTML = headerHTML + tallasHTML;
            listaPendientes.appendChild(li);
        });

        listaPendientes.querySelectorAll('[data-detalle-id]').forEach(item => {
            item.addEventListener('click', () => {
                const detalleId = item.dataset.detalleId;
                for(const grupo of Object.values(gruposData)){
                    const found = grupo.tallas.find(t => t.detalle.id == detalleId);
                    if(found) {
                        actualizarProductoActivoCard(found.detalle);
                        break;
                    }
                }
            });
        });
    }
    
    function actualizarTotalesGenerales() {
        let totalPedido = 0, totalDespachado = 0;
        Object.values(gruposData).forEach(g => { totalPedido += g.total_pedida; totalDespachado += g.total_verificada; });
        totalPedidoDisplay.textContent = totalPedido;
        totalDespachadoDisplay.textContent = totalDespachado;
        totalPendienteDisplay.textContent = totalPedido - totalDespachado;
    }
    
    async function guardarTodosDetallesParcialmente() {
        const detallesParaGuardar = Object.values(detallesIndividualesPorCodigoBarras).map(d => ({ id: d.id, cantidad_verificada_nueva: d.cantidad_verificada }));
        if (detallesParaGuardar.length === 0) {
            mostrarStatus('No hay productos para guardar.', 'info', 3000, true);
            return;
        }
        try {
            mostrarStatus('Guardando progreso...', 'info', 0);
            const response = await fetch(guardarParcialUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ detalles_a_guardar: detallesParaGuardar })
            });
            const result = await response.json();
            if (result.status === 'success') {
                mostrarStatus(`✔️ ${result.message}`, 'success', 5000, true);
                playSound('success');
            } else {
                mostrarStatus(`❌ Error: ${result.message}`, 'danger', 10000, true);
                playSound('error');
            }
        } catch (error) {
            mostrarStatus('Error de conexión al guardar. Verifique su red.', 'danger', 10000, true);
        }
    }
    async function guardarDetalleParcialmente(detalleId, nuevaCantidad) {
        const data = { detalles_a_guardar: [{ id: detalleId, cantidad_verificada_nueva: nuevaCantidad }] };
        try {
            const response = await fetch(guardarParcialUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (result.status !== 'success' && result.status !== 'info') {
                 console.error(`Error al guardar individual: ${result.message}`);
                 mostrarStatus(`Error al guardar individual: ${result.message}`, 'danger', 5000, true);
            }
        } catch (error) {
            console.error('Error de red al guardar individual:', error);
            mostrarStatus('Error de conexión al guardar (individual).', 'danger', 5000, true);
        }
    }

    function procesarScan(codigo) {
        const detalleIndividual = detallesIndividualesPorCodigoBarras[codigo.trim()];
        if (detalleIndividual) {
            if (detalleIndividual.cantidad_verificada < detalleIndividual.cantidad_pedida) {
                detalleIndividual.cantidad_verificada += 1;
                mostrarStatus(`✔️ ${detalleIndividual.referencia} (${detalleIndividual.cantidad_verificada}/${detalleIndividual.cantidad_pedida})`, 'success');
                playSound('success');
                const grupo = gruposData[detalleIndividual.grupoKey];
                if (grupo) grupo.total_verificada += 1;
                guardarDetalleParcialmente(detalleIndividual.id, detalleIndividual.cantidad_verificada); 
             } else {
                // Mensaje de advertencia mejorado, ahora en modal
                const mensaje = `La referencia <strong>${detalleIndividual.referencia}</strong> talla <strong>${detalleIndividual.talla_nombre}</strong> ya está completa. (${detalleIndividual.cantidad_verificada}/${detalleIndividual.cantidad_pedida})`;
                mostrarStatus(mensaje, 'warning', 3000, true);
                playSound('error');
            }
            actualizarProductoActivoCard(detalleIndividual);
            renderListaPendientes();
            actualizarTotalesGenerales();
        } else {
            mostrarStatus(`❌ Código no encontrado: ${codigo}`, 'danger', 2500, true);
            playSound('error');
        }
        barcodeInput.value = '';
        barcodeInput.focus();
    }
    
    // Event Listeners
    barcodeInput.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); if (barcodeInput.value.trim()) procesarScan(barcodeInput.value.trim()); } });
    btnEnviarParcial.addEventListener('click', async function() {
        if (!confirm('¿Está seguro de enviar este despacho parcial y generar un comprobante?')) return;
        try {
            mostrarStatus('Enviando despacho parcial...', 'info', 0);
            const response = await fetch(enviarParcialUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({})
            });
            const result = await response.json();
            if (result.status === 'success') {
                mostrarStatus(`✔️ ${result.message}`, 'success', 5000, true);
                playSound('success');
                if (result.comprobante_url) {
                    window.open(result.comprobante_url, '_blank');
                    window.location.reload();
                }
            } else {
                mostrarStatus(`❌ Error al enviar: ${result.message}`, 'danger', 10000, true);
                playSound('error');
            }
        } catch (error) {
            mostrarStatus('Error de conexión al enviar. Verifique su red.', 'danger', 10000, true);
        }
    });

    // Inicialización final
    actualizarTotalesGenerales();
    renderListaPendientes();
    barcodeInput.focus();
});
</script>
{% endblock extra_scripts %}